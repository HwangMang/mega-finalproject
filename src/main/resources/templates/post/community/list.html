<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}" th:with="activeTab='', title='community'"
      xmlns:td="http://www.w3.org/1999/html">
<head>
    <style>
        .pagination {
            justify-content: center;
        }
    </style>

    <script th:inline="javascript">
        $(document).ready(function () { //좋아요
            $(".like").click(function () {
                let data = $(this).val();
                $.ajax({
                    type: 'GET',
                    url: '/community/list/like',
                    data: {"id": data},
                    dataType: 'json',
                    success: function (result) {
                        if (result.resultCode == "error.auth") {
                            alert(result.message);
                        } else if (result.resultCode == "error.invalid") {
                            alert(result.message);
                        } else if (result.resultCode == "ok") {
                            $("#" + data).attr("src", "/images/like_red.svg");
                            $('#likeNum' + data).html(result.likeCheck);
                        } else if (result.resultCode == "error.duplicate") {
                            $("#" + data).attr("src", "/images/like.svg");
                            $('#likeNum' + data).text(result.likeCheck);
                        }
                    }
                });
            });
        });



    </script>
</head>
<body>

<div layout:fragment="content">
    <div class="container">
        <main>
            <div class="py-5 text-center">
                <h2>커뮤니티 리스트</h2>
            </div>

            <form class="justify-content-center" method="get" th:action="@{/community/list/category}">

                <!-- 검색창 -->
                <div class="form-group d-flex justify-content-center row">
                    <input type="text" class="form-control form-control-lg col-6" th:value="${searchText}"
                           id="searchText" name="searchText">
                    <button type="submit" class="btn btn-info col-1">검색</button>
                </div>
                <!-- 정렬 -->
<!--                <div class="form-group d-flex justify-content-end" id="line_option" style="float: right">-->
<!--&lt;!&ndash;                    <select id="lineUp" name="lineUp" class="form-control">&ndash;&gt;-->
<!--&lt;!&ndash;                        <option name="sort" th:value="new">최신순</option>&ndash;&gt;-->
<!--&lt;!&ndash;                        <option name="sort" th:value="like">좋아요순</option>&ndash;&gt;-->
<!--&lt;!&ndash;                    </select>&ndash;&gt;-->
<!--                </div>-->


                <!-- 글쓰기 -->
                <div id="review_write" class="container justify-content-end">
                    <a class="btn btn-outline-info" th:href="@{/community/write}">글쓰기</a>
                </div>

                <!-- 카테고리-->

                <!--검색 했을때 -->
                <div th:if="${state.toString.equals('search')}">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="/community/list/all" th:value="search">검색 결과</a>
                        </li>
                    </ul>
                </div>
                <!--검색 안 했을때 -->
                <div th:unless="${state.toString.equals('search')}">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a th:class="${state.toString.equals('all')? 'nav-link active' : 'nav-link'}"
                               th:href="@{/community/list/category(community=all)}" th:value="all" th:id="category">전체 글</a>
                        </li>
                        <li class="nav-item">
                            <a th:class="${state.equals('tip')? 'nav-link active' : 'nav-link'}"
                               th:href="@{/community/list/category(community=tip)}">자취방 꿀팁</a>
                        </li>
                        <li class="nav-item">
                            <a th:class="${state.toString.equals('interior')? 'nav-link active' : 'nav-link'}"
                               th:href="@{/community/list/category(community=interior)}">자취방 인테리어</a>
                        </li>
                        <li class="nav-item">
                            <a th:class="${state.toString.equals('eat')? 'nav-link active' : 'nav-link'}"
                               th:href="@{/community/list/category(community=eat)}">동네 맛집</a>
                        </li>
                        <li class="nav-item">
                            <a th:class="${state.toString.equals('board')? 'nav-link active' : 'nav-link'}"
                               th:href="@{/community/list/category(community=board)}">자유 게시판</a>
                        </li>
                    </ul>
                    <input th:type="hidden" th:value="categorry">
                </div>


                <!--리스트 -->
                <div th:if="${communityList.isEmpty()}" style="text-align: center;" th:id="sortTable">
                    <h2>검색결과가 없습니다.</h2>
                </div>

                <div class="table" id="community_table">
                    <table class="table table-borderless wd-250" th:each="product : ${communityList}"
                           style="table-layout: fixed">
                        <tr>
                            <td th:colspan="6" th:if="${product.communityCategory.toString().equals('EAT')}">동네 맛집</td>
                            <td th:colspan="6" th:if="${product.communityCategory.toString().equals('TIP')}">자취방 꿀팁</td>
                            <td th:colspan="6" th:if="${product.communityCategory.toString().equals('INTERIOR')}">자취방
                                인테리어
                            </td>
                            <td th:colspan="6" th:if="${product.communityCategory.toString().equals('BOARD')}">자유</td>
                        </tr>

                        <tr>
                            <td colspan="4">
                                <a th:href="@{/community/read(id=${product.id})}" th:value="${product.id}"
                                   class="review_read"
                                   style="text-decoration-line: none; color:black;">
                                    <span th:text="${product.postName} + '&nbsp;&nbsp;'"
                                          style="font-size: 23px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width: 100"/>
                                    <span th:text="${#temporals.format(product.regdate, 'yyyy-MM-dd HH:mm:ss')}"
                                          style="font-size: 15px; color: grey"/>
                                </a>
                            </td>
                            <td th:colspan="1">조회 <span th:text="${product.hit}"> </span></td>

                            <td th:colspan="1">
                                <button type="button" class="like"
                                        style="border:0px; outline:0px;background-color:transparent;"
                                        th:id="like" th:value="${product.id}">
                                    <img th:src="@{ ${member?.likes?.contains(product)} ?  '/images/like_red.svg' : '/images/like.svg'}"
                                         th:id="${product.id}" th:width="25" th:height="25"></button>
                                <span th:text="${product.likers.size}" th:id="likeNum+${product.id}"></span>
                            </td>


                        </tr>

                        <tr>
                            <td colspan="6" width="1500" height="64"
                                th:utext="${product.postContent.toString().replaceAll('<(/)?([a-zA-Z]*)(\\s[a-zA-Z]*=[^>]*)?(\\s)*(/)?>',' ')
                                .replaceAll('<\/?(span|font)[^>]*>',' ')
                                .replaceAll('<img',' ')
                                }"
                                style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis;"></td>

                        </tr>
                        <tr>
                            <td th:colspan="6">
                                <span th:each="t: ${product.tags}">
                 <span th:text="${t.tagName}" style="background-color: #eeeeee"></span>
                </span>
                            </td>
                        </tr>
                        <hr class="col-12 my-4">
                    </table>

                </div>

            </form>
            <div th:unless="${communityList.isEmpty()}">
                <div th:if="${!state.toString().equals('search')}">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                        <li class="page-item"
                            th:classappend="${1 == communityList.pageable.pageNumber + 1} ? 'disabled'">
                            <a class="page-link" href="#"
                               th:href="@{/community/list/category(page=${communityList.pageable.pageNumber - 1}
                               ,community=${param.community})}"
                               tabindex="-1" aria-disabled="true"> &lt; </a>
                        </li>
                        <li class="page-item" th:classappend="${i == communityList.pageable.pageNumber+1} ? 'active'"
                            th:each="i : ${#numbers.sequence(startPage, endPage)}">
                            <a class="page-link" href="#" th:href="@{/community/list/category(page=${i - 1},community=${param.community})}"
                               th:text="${i}">1</a>
                        </li>
                        <li class="page-item"
                            th:classappend="${communityList.totalPages == communityList.pageable.pageNumber + 1} ? 'disabled'">
                            <a class="page-link" href="#"
                               th:href="@{/community/list/category(page=${communityList.pageable.pageNumber + 1},community=${param.community})}"> &gt </a>
                        </li>

                    </ul>
                </nav>
                </div>

                <div th:if="${state.toString().equals('search')}">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center">
                            <li class="page-item"
                                th:classappend="${1 == communityList.pageable.pageNumber + 1} ? 'disabled'">
                                <a class="page-link" href="#"
                                   th:href="@{/community/list/category(page=${communityList.pageable.pageNumber - 1},searchText=${param.searchText},community=${param.community})}"
                                   tabindex="-1" aria-disabled="true"> &lt; </a>
                            </li>
                            <li class="page-item" th:classappend="${i == communityList.pageable.pageNumber+1} ? 'active'"
                                th:each="i : ${#numbers.sequence(startPage, endPage)}">
                                <a class="page-link" href="#" th:href="@{/community/list/category(page=${i - 1},searchText=${param.searchText},community=${param.community})}"
                                   th:text="${i}">1</a>
                            </li>
                            <li class="page-item"
                                th:classappend="${communityList.totalPages == communityList.pageable.pageNumber + 1} ? 'disabled'">
                                <a class="page-link" href="#"
                                   th:href="@{/community/list/category(page=${communityList.pageable.pageNumber + 1},searchText=${param.searchText},community=${param.community})}"> &gt </a>
                            </li>

                        </ul>
                    </nav>

                </div>
            </div>

        </main>
    </div>
</div>
</body>
</html>